<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <!-- FullCalendar and dependencies -->
    <link rel="icon" type="image/png" href="../images/logo.png" />
    <!-- For .png files -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
    <!-- Custom styles -->
    <link rel="stylesheet" href="../styles/styles-admin.css" />
  </head>
  <body>
    <header>
      <h1>Admin Panel</h1>
    </header>
    <main>
      <section class="bookings-section">
        <h2>Bookings</h2>

        <table id="bookings-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Dept</th>
              <th>Event</th>
              <th>Resource Person</th>
              <th>Auditorium</th>
              <th>Date</th>
              <th>Start</th>
              <th>End</th>
              <th>Amenities</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="bookings-body">
            <!-- Bookings will be dynamically added here -->
          </tbody>
          <div id="dialogBox" class="dialog-box hidden">
            <div class="dialog-content">
              <h3>Configure Booking Details</h3>
              <div id="sectionsContainer">
                <!-- Sections will be dynamically added here -->
              </div>
              <button id="addSectionBtn">Add Section</button>
              <div class="dialog-actions">
                <button id="cancelBtn">Cancel</button>
                <button id="saveBtn">Save</button>
              </div>
            </div>
          </div>
          <div id="dialogBox" class="dialog-box hidden">
            <div class="dialog-content">
              <h3>Select Technician</h3>
              <select id="technicianDropdown">
                <!-- Technician options will be populated dynamically -->
              </select>
              <button id="okBtn">OK</button>
              <button id="cancelBtn">Cancel</button>
            </div>
          </div>
          <div id="cancelReasonDialog" class="popup hidden">
            <div class="popup-content">
              <h3>Select Reason for Cancellation</h3>
              <form id="cancelReasonForm">
                <div class="popup-reason-options">
                  <label>
                    <input
                      type="radio"
                      name="cancelReason"
                      value="Reason 1"
                      required
                    />
                    Reason 1
                  </label>
                  <label>
                    <input type="radio" name="cancelReason" value="Reason 2" />
                    Reason 2
                  </label>
                  <label>
                    <input type="radio" name="cancelReason" value="Reason 3" />
                    Reason 3
                  </label>
                  <label>
                    <input type="radio" name="cancelReason" value="Reason 4" />
                    Reason 4
                  </label>
                  <label>
                    <input type="radio" name="cancelReason" value="custom" />
                    Custom Reason
                  </label>
                  <textarea
                    id="customReasonInput"
                    name="customReason"
                    placeholder="Enter custom reason"
                    disabled
                  ></textarea>
                </div>
                <div class="popup-actions">
                  <button type="button" id="cancelPopupBtn">Cancel</button>
                  <button type="submit" id="confirmPopupBtn">Confirm</button>
                </div>
              </form>
            </div>
          </div>
        </table>
        <div id="message-box" class="message-box"></div>
        <button id="print-csv">Print CSV</button>
        <button id="show-user">Show User</button>
        <button id="show-admin">Show Admin</button>
        <button id="show-technician">Show Technician</button>
        <button id="print-user">Print User CSV</button>
        <button id="print-admin">Print Admin CSV</button>
        <button id="print-technician">Print Technician CSV</button>
      </section>
      <section class="Tabular-shown">
        <div id="modal" class="modal">
          <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">User Data</h3>
            <table id="modal-table">
              <!-- Table will be dynamically added here -->
            </table>
          </div>
        </div>
      </section>

      <section class="calendar-section">
        <h2>Calendar View</h2>
        <div id="calendar"></div>
      </section>
    </main>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const bookingsTable = document.getElementById("bookings-body");
        const messageBox = document.getElementById("message-box");

        // Fetch bookings from the server
        function fetchBookings() {
          return fetch(
            "https://auditorium-booking-i34f.onrender.com/admin/bookings"
          )
            .then((response) => response.json())
            .catch((error) => {
              console.error("Error fetching bookings:", error);
              showMessage("Error fetching bookings", "error");
            });
        }

        // Function to export bookings to CSV
        function exportBookingsToCSV(bookings) {
          const csvRows = [];
          const headers = [
            "Name",
            "Dept",
            "Event",
            "Resorce Person",
            "Auditorium",
            "Date",
            "Start",
            "End",
            "Amenities",
            "Status",
          ];
          csvRows.push(headers.join(","));

          const auditoriumMapping = {
            auditorium1: "KS",
            auditorium2: "KK",
            auditorium3: "Open Air Auditorium",
            auditorium4: "Main Ground",
            auditorium5: "Indoor Stadium",
            auditorium6: "CSE Seminar Hall",
            auditorium7: "IT Seminar Hall",
            auditorium8: "ECE Seminar Hall",
            auditorium9: "EEE Seminar Hall",
            auditorium10: "Mechanical Seminar Hall",
            auditorium11: "Civil Seminar Hall",
            auditorium12: "Architecture Seminar Hall",
          };

          bookings.forEach((booking) => {
            const auditoriumCode =
              auditoriumMapping[booking.auditorium] || booking.auditorium;
            const row = [
              booking.user.name,
              booking.user.dept,
              booking.events_name,
              booking.events_resourceperson,
              auditoriumCode,
              new Date(booking.date).toLocaleDateString(),
              booking.start, // Start Time
              booking.end, // End Time
              booking.amenities.join("; "),
              booking.status,
            ];
            csvRows.push(row.join(","));
          });

          const csvString = csvRows.join("\n");
          const blob = new Blob([csvString], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.setAttribute("hidden", "");
          a.setAttribute("href", url);
          a.setAttribute("download", "bookings.csv");
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        function updateCalendar(bookings) {
          const auditoriumMapping = {
            auditorium1: "KS",
            auditorium2: "KK",
            auditorium3: "Open Air Auditorium",
            auditorium4: "Main Ground",
            auditorium5: "Indoor Stadium",
            auditorium6: "CSE Seminar Hall",
            auditorium7: "IT Seminar Hall",
            auditorium8: "ECE Seminar Hall",
            auditorium9: "EEE Seminar Hall",
            auditorium10: "Mechanical Seminar Hall",
            auditorium11: "Civil Seminar Hall",
            auditorium12: "Architecture Seminar Hall",
          };

          const newBookings = bookings
            .map((booking) => {
              const auditoriumCode =
                auditoriumMapping[booking.auditorium] || booking.auditorium;

              console.log(auditoriumCode);

              let bookingDate;
              try {
                const dateParts = booking.date.split("T");
                bookingDate = dateParts[0]; // Get the date part only
              } catch (error) {
                console.error("Invalid booking date:", error);
                return null;
              }

              const startTime = booking.start.includes(":")
                ? booking.start
                : `${booking.start}:00`;
              const endTime = booking.end.includes(":")
                ? booking.end
                : `${booking.end}:00`;

              // Full date-time strings with the date and time
              const start = `${bookingDate}T${startTime}`;
              const end = `${bookingDate}T${endTime}`;

              let correctedStart, correctedEnd;
              try {
                correctedStart = new Date(start).toISOString(); // Full ISO string
                correctedEnd = new Date(end).toISOString(); // Full ISO string
              } catch (error) {
                console.error("Invalid start or end time:", start, end);
                return null;
              }

              console.log("Returning " + booking._id);

              return {
                id: booking._id,
                title: `${auditoriumCode} ${booking.events_name}`,
                start: correctedStart, // Full date and time
                end: correctedEnd, // Full date and time
                backgroundColor:
                  booking.status === "Approved" ? "green" : "grey",
                borderColor: booking.status === "Approved" ? "green" : "grey",
              };
            })
            .filter((booking) => booking !== null); // Filter out any invalid bookings

          console.log("New Bookings: " + newBookings.length);
          return newBookings;
        }

        function initializeCalendar(bookings) {
          console.log("Bookings for calendar: ", bookings);

          $("#calendar").fullCalendar({
            header: {
              left: "prev",
              center: "title",
              right: "next",
            },
            defaultView: "month",
            displayEventTime: false, // Hide time next to title

            events: async function (start, end, timezone, callback) {
              try {
                const newBookings = updateCalendar(bookings);
                callback(newBookings);
              } catch (err) {
                console.log(err);
              }
            },
            eventRender: function (event, element) {
              console.log(event);
              element.attr("title", event.tooltip); // Display full title on hover
            },
            eventClick: function (calEvent) {
              console.log("Event clicked:", calEvent);
            },
          });
        }
        function displayBookings(bookings) {
          bookingsTable.innerHTML = ""; // Clear the table body
          const auditoriumMapping = {
            auditorium1: "KS",
            auditorium2: "KK",
            auditorium3: "Open Air Auditorium",
            auditorium4: "Main Ground",
            auditorium5: "Indoor Stadium",
            auditorium6: "CSE Seminar Hall",
            auditorium7: "IT Seminar Hall",
            auditorium8: "ECE Seminar Hall",
            auditorium9: "EEE Seminar Hall",
            auditorium10: "Mechanical Seminar Hall",
            auditorium11: "Civil Seminar Hall",
            auditorium12: "Architecture Seminar Hall",
          };

          bookings.forEach((booking, index) => {
            const row = document.createElement("tr");
            const auditoriumCode =
              auditoriumMapping[booking.auditorium] || booking.auditorium;

            // Determine if this booking overlaps with any other booking
            let isOverlapping = false;
            for (let i = 0; i < bookings.length; i++) {
              if (i !== index) {
                const otherBooking = bookings[i];

                // Check if they are on the same date and in the same auditorium
                if (
                  booking.date === otherBooking.date &&
                  booking.auditorium === otherBooking.auditorium
                ) {
                  const bookingStart = new Date(
                    `${booking.date}T${booking.start}`
                  );
                  const bookingEnd = new Date(`${booking.date}T${booking.end}`);
                  const otherStart = new Date(
                    `${otherBooking.date}T${otherBooking.start}`
                  );
                  const otherEnd = new Date(
                    `${otherBooking.date}T${otherBooking.end}`
                  );

                  // Check for time overlap
                  if (bookingStart < otherEnd && bookingEnd > otherStart) {
                    isOverlapping = true;
                    break; // Exit loop once overlap is found
                  }
                }
              }
            }
            // Add highlighting class if there is an overlap
            const rowClass = isOverlapping ? "overlapping-booking" : "";

            try {
              row.innerHTML = `
        <td>${booking.user.name}</td>
        <td>${booking.user.dept}</td>
        <td>${booking.events_name}</td>
        <td>${booking.events_resourceperson}</td>
        <td>${auditoriumCode}</td>
        <td>${new Date(booking.date).toLocaleDateString()}</td>
        <td>${booking.start}</td>
        <td>${booking.end}</td>
        <td>${booking.amenities.join(", ")}</td>
        <td>${booking.status}</td>
        <td>
          <button class="approve-button" data-booking-id="${
            booking._id
          }">Approve</button>
          <button class="cancel-button" data-booking-id="${
            booking._id
          }">Disapprove</button>
        </td>
      `;

              // Apply the class to highlight overlapping rows
              if (isOverlapping) {
                row.classList.add(rowClass);
              }

              bookingsTable.appendChild(row);
            } catch (error) {
              console.error("Error creating booking row:", error);
            }
            // // Function to open the dialog with a booking ID
            // window.openCancelReasonDialog = function (bookingId) {
            //   currentBookingId = bookingId; // Set the booking ID dynamically
            //   console.log(`Opening dialog for booking ID: ${bookingId}`);
            //   cancelReasonDialog.classList.remove("hidden");
            // };
            const approveButton = row.querySelector(".approve-button");
            approveButton.addEventListener("click", () => {
              showDialog(booking._id, booking.user.name); // Call the showDialog function with the booking ID
            });

            // // Sample cancelBooking function
            // function cancelBooking(bookingId, reason) {
            //   // Implement the API call or server request here
            //   console.log(`Booking ID: ${bookingId}, Reason: ${reason}`);
            // }
            async function showCancelReasonDialog(bookingId) {
              console.log("Function s1");
              const cancelReasonDialog =
                document.getElementById("cancelReasonDialog");
              const customReasonInput =
                document.getElementById("customReasonInput");
              const reasonRadios = document.getElementsByName("cancelReason");
              const cancelPopupBtn = document.getElementById("cancelPopupBtn");
              const cancelReasonForm =
                document.getElementById("cancelReasonForm");

              let selectedReason = null;

              // Open the dialog
              cancelReasonDialog.classList.remove("hidden");

              // Reset inputs
              reasonRadios.forEach((radio) => (radio.checked = false));
              customReasonInput.value = "";
              customReasonInput.disabled = true;

              // Function to enable/disable the custom reason input
              function handleReasonChange(event) {
                selectedReason = event.target.value;
                console.log(`Selected reason: ${selectedReason}`);
                customReasonInput.disabled = selectedReason !== "custom";
              }

              // Attach change event listeners to radio buttons
              reasonRadios.forEach((radio) => {
                radio.addEventListener("change", handleReasonChange);
              });

              // Function to hide the dialog
              function closeDialog() {
                console.log("Cancel button clicked, hiding popup.");
                cancelReasonDialog.classList.add("hidden");
              }

              cancelPopupBtn.addEventListener("click", closeDialog);

              // Handle form submission
              async function handleFormSubmit(event) {
                event.preventDefault();

                // Get the selected reason
                const selectedRadio = Array.from(reasonRadios).find(
                  (radio) => radio.checked
                );
                if (!selectedRadio) {
                  alert("Please select a reason for cancellation.");
                  return;
                }

                const reason = selectedRadio.value;
                const customReason = customReasonInput.value.trim();

                // Validate custom reason
                if (reason === "custom" && !customReason) {
                  alert("Please provide a custom reason.");
                  return;
                }

                const finalReason = reason === "custom" ? customReason : reason;

                // Log and perform the cancellation logic
                console.log(`Final cancellation reason: ${finalReason}`);
                await cancelBooking(bookingId, finalReason);

                // Close the dialog after submission
                closeDialog();
              }

              cancelReasonForm.addEventListener("submit", handleFormSubmit);
            }

            // Main functionality
            const cancelButton = row.querySelector(".cancel-button");
            const bookingId = cancelButton.getAttribute("data-booking-id");

            cancelButton.addEventListener("click", () => {
              // Open the modal
              // showCancelDialog(bookingId);
              // openDialog();
              showCancelReasonDialog(bookingId);
              console.log("Opening Cancel Modal");
            });

            // document.addEventListener("DOMContentLoaded", () => {
            //   const customReasonInput = document.getElementById("customReasonInput");
            //   const reasonRadios = document.getElementsByName("cancelReason");
            //   const cancelPopupBtn = document.getElementById("cancelPopupBtn");
            //   const cancelReasonDialog = document.getElementById("cancelReasonDialog");
            //   let currentBookingId = null; // To store the current booking ID dynamically

            //   // Enable/Disable custom reason textarea
            //   reasonRadios.forEach((radio) => {
            //     radio.addEventListener("change", () => {
            //       console.log(`Selected reason: ${radio.value}`);
            //       customReasonInput.disabled = radio.value !== "custom";
            //     });
            //   });

            //   // Cancel button to hide dialog
            //   cancelPopupBtn.addEventListener("click", () => {
            //     console.log("Cancel button clicked, hiding popup.");
            //     cancelReasonDialog.classList.add("hidden");
            //   });

            //   // Form submission logic
            //   document
            //     .getElementById("cancelReasonForm")
            //     .addEventListener("submit", (e) => {
            //       e.preventDefault();

            //       // Find the selected reason
            //       const selectedReasonRadio = [...reasonRadios].find(
            //         (radio) => radio.checked
            //       );
            //       if (!selectedReasonRadio) {
            //         console.log("No reason selected.");
            //         alert("Please select a reason for cancellation.");
            //         return;
            //       }

            //       const selectedReason = selectedReasonRadio.value;
            //       const customReason = customReasonInput.value.trim();

            //       // Validate custom reason
            //       if (selectedReason === "custom" && !customReason) {
            //         console.log("Custom reason is empty.");
            //         alert("Please provide a custom reason.");
            //         return;
            //       }

            //       const finalReason =
            //         selectedReason === "custom" ? customReason : selectedReason;

            //       // Log and call the cancelBooking function
            //       console.log(`Final cancellation reason: ${finalReason}`);
            //       cancelBooking(currentBookingId, finalReason);

            //       // Hide popup after submission
            //       cancelReasonDialog.classList.add("hidden");
            //     });

            // });

            //             function showCancelDialog(bookingId) {
            //   const dialog = document.getElementById("cancel-dialog");

            //   // Remove 'hidden' class to show the dialog
            //   dialog.classList.remove("hidden");

            //   const customReasonTextarea = dialog.querySelector("#customReason");
            //   const form = dialog.querySelector("#cancelForm");

            //   // Enable custom reason textarea if "Custom" is selected
            //   form.addEventListener("change", (e) => {
            //     if (e.target.name === "reason" && e.target.value === "Custom") {
            //       customReasonTextarea.disabled = false;
            //     } else {
            //       customReasonTextarea.disabled = true;
            //     }
            //   });

            //   // Handle form submission
            //   form.addEventListener("submit", (e) => {
            //     e.preventDefault();
            //     const selectedReason = form.reason.value;
            //     const customReason = customReasonTextarea.value.trim();
            //     const reasonToSend =
            //       selectedReason === "Custom" ? customReason : selectedReason;

            //     console.log(`Cancel booking ID: ${bookingId}, Reason: ${reasonToSend}`);
            //     cancelBooking(bookingId, reasonToSend); // Call your cancel function

            //     dialog.classList.add("hidden"); // Hide the dialog after submission
            //   });

            //   // Handle close button
            //   const closeButton = dialog.querySelector(".close-button");
            //   closeButton.addEventListener("click", () => {
            //     dialog.classList.add("hidden"); // Hide the dialog when close is clicked
            //   });
            // }
            // // Function to open the dialog
            // function openDialog() {
            //   const dialog = document.getElementById("dialog-box");
            //   dialog.classList.remove("hidden"); // Show the dialog
            // }

            // // Function to handle form submission and return the selected option
            // function handleFormSubmit(event) {
            //   event.preventDefault();

            //   const form = document.getElementById("dialogForm");
            //   const selectedOption = form.option.value; // Get the selected option
            //   console.log("Selected Option:", selectedOption);

            //   // You can return or use the selected option as needed
            //   alert(`You selected: ${selectedOption}`);

            //   // Close the dialog
            //   const dialog = document.getElementById("dialog-box");
            //   dialog.classList.add("hidden");
            // }

            // // Close the dialog when the close button is clicked
            // function closeDialog() {
            //   const dialog = document.getElementById("dialog-box");
            //   dialog.classList.add("hidden"); // Hide the dialog
            // }

            // // Event listeners for form submission and close button
            // document.getElementById("dialogForm").addEventListener("submit", handleFormSubmit);
            // document.querySelector(".close-button").addEventListener("click", closeDialog);

            //             function openCancelModal(bookingId) {
            //   console.log("Opening Cancel Modal");

            //   const modal = document.getElementById("cancel-modal");
            //   modal.classList.remove("hidden"); // Show the modal

            //   const customReasonTextarea = modal.querySelector("#customReason");
            //   const form = modal.querySelector("#cancelForm");

            //   // Enable custom reason textarea if "Custom" is selected
            //   form.addEventListener("change", (e) => {
            //     if (e.target.name === "reason" && e.target.value === "Custom") {
            //       customReasonTextarea.disabled = false;
            //     } else {
            //       customReasonTextarea.disabled = true;
            //     }
            //   });

            //   // Handle form submission
            //   form.addEventListener("submit", (e) => {
            //     e.preventDefault();
            //     const selectedReason = form.reason.value;
            //     const customReason = customReasonTextarea.value.trim();
            //     const reasonToSend =
            //       selectedReason === "Custom" ? customReason : selectedReason;

            //     console.log(`Cancel booking ID: ${bookingId}, Reason: ${reasonToSend}`);
            //     cancelBooking(bookingId, reasonToSend); // Call your cancel function

            //     modal.classList.add("hidden"); // Hide the modal
            //   });

            //   // Handle modal close button
            //   const closeButton = modal.querySelector(".close-button");
            //   closeButton.addEventListener("click", () => {
            //     modal.classList.add("hidden"); // Hide the modal
            //   });
            // }

            //           function openCancelModal(bookingId) {
            //             // Create modal dynamically
            //             console.log("Open Modal called successfully");
            //             const modal = document.createElement("div");
            //             modal.className = "modal";
            //             modal.innerHTML = `
            //   <div class="modal-content">
            //     <h2>Cancel Booking</h2>
            //     <p>Select a reason for cancellation:</p>
            //     <form id="cancelForm">
            //       <label>
            //         <input type="radio" name="reason" value="Reason 1" required>
            //         Reason 1
            //       </label><br>
            //       <label>
            //         <input type="radio" name="reason" value="Reason 2">
            //         Reason 2
            //       </label><br>
            //       <label>
            //         <input type="radio" name="reason" value="Reason 3">
            //         Reason 3
            //       </label><br>
            //       <label>
            //         <input type="radio" name="reason" value="Reason 4">
            //         Reason 4
            //       </label><br>
            //       <label>
            //         <input type="radio" name="reason" value="Custom">
            //         Other (Specify below)
            //       </label><br>
            //       <textarea id="customReason" placeholder="Write your reason here..." disabled></textarea>
            //       <br>
            //       <button type="submit" class="submit-button">Submit</button>
            //       <button type="button" class="close-button">Close</button>
            //     </form>
            //   </div>
            // `;
            //             document.body.appendChild(modal);

            //             // Enable custom reason textarea if "Custom" is selected
            //             const form = modal.querySelector("#cancelForm");
            //             const customReasonTextarea = form.querySelector("#customReason");
            //             form.addEventListener("change", (e) => {
            //               if (e.target.name === "reason" && e.target.value === "Custom") {
            //                 customReasonTextarea.disabled = false;
            //               } else {
            //                 customReasonTextarea.disabled = true;
            //               }
            //             });

            //             // Handle form submission
            //             form.addEventListener("submit", (e) => {
            //               e.preventDefault();
            //               const selectedReason = form.reason.value;
            //               const customReason = customReasonTextarea.value.trim();
            //               const reasonToSend =
            //                 selectedReason === "Custom" ? customReason : selectedReason;

            //               // Call cancelBooking with the booking ID and selected reason
            //               cancelBooking(bookingId, reasonToSend);

            //               // Close the modal
            //               document.body.removeChild(modal);
            //             });

            //             // Handle modal close
            //             modal
            //               .querySelector(".close-button")
            //               .addEventListener("click", () => {
            //                 document.body.removeChild(modal);
            //               });
            //           }
            //           function openCancelModal(bookingId) {
            //             console.log("Open Modal called successfully");
            //             const modal = document.createElement("div");
            //             modal.className = "modal show"; // Add the 'show' class to make it visible
            //             modal.innerHTML = `
            //   <div class="modal-content">
            //     <h2>Cancel Booking</h2>
            //     <p>Select a reason for cancellation:</p>
            //     <form id="cancelForm">
            //       <label>
            //         <input type="radio" name="reason" value="Reason 1" required>
            //         Reason 1
            //       </label><br>
            //       <label>
            //         <input type="radio" name="reason" value="Reason 2">
            //         Reason 2
            //       </label><br>
            //       <label>
            //         <input type="radio" name="reason" value="Reason 3">
            //         Reason 3
            //       </label><br>
            //       <label>
            //         <input type="radio" name="reason" value="Reason 4">
            //         Reason 4
            //       </label><br>
            //       <label>
            //         <input type="radio" name="reason" value="Custom">
            //         Other (Specify below)
            //       </label><br>
            //       <textarea id="customReason" placeholder="Write your reason here..." disabled></textarea>
            //       <br>
            //       <button type="submit" class="submit-button">Submit</button>
            //       <button type="button" class="close-button">Close</button>
            //     </form>
            //   </div>
            // `;
            //             document.body.appendChild(modal);

            //             // Enable custom reason textarea if "Custom" is selected
            //             const form = modal.querySelector("#cancelForm");
            //             const customReasonTextarea = form.querySelector("#customReason");
            //             form.addEventListener("change", (e) => {
            //               if (e.target.name === "reason" && e.target.value === "Custom") {
            //                 customReasonTextarea.disabled = false;
            //               } else {
            //                 customReasonTextarea.disabled = true;
            //               }
            //             });

            //             // Handle form submission
            //             form.addEventListener("submit", (e) => {
            //               e.preventDefault();
            //               const selectedReason = form.reason.value;
            //               const customReason = customReasonTextarea.value.trim();
            //               const reasonToSend =
            //                 selectedReason === "Custom" ? customReason : selectedReason;

            //               // Call cancelBooking with the booking ID and selected reason
            //               cancelBooking(bookingId, reasonToSend);

            //               // Close the modal
            //               document.body.removeChild(modal);
            //             });

            //             // Handle modal close
            //             modal
            //               .querySelector(".close-button")
            //               .addEventListener("click", () => {
            //                 document.body.removeChild(modal);
            //               });
            //           }

            // Add event listener to the Cancel button (optional)
            // const cancelButton = row.querySelector(".cancel-button");
            // const bookingId = cancelButton.getAttribute("data-booking-id");
            // cancelButton.addEventListener("click", () => {
            //   // Implement cancel functionality if required
            //   cancelButton.addEventListener("click", () =>
            //     cancelBooking(bookingId)
            //   );
            //   console.log(`Cancel booking ID: ${booking._id},${bookingId}`);
            // });
            //       cancelButton.forEach((button) => {
            //   const bookingId = button.getAttribute("data-booking-id");
            //   button.addEventListener("click", () => cancelBooking(bookingId));
            // });
          });

          attachEventListeners(); // Attach the event listeners after table is updated
        }

        // Show message in the message box
        function showMessage(message, type) {
          messageBox.textContent = message;
          messageBox.className = `message-box ${type}`;
          setTimeout(() => (messageBox.textContent = ""), 5000); // Clear message after 5 seconds
        }

        async function showDialog(bookingId, userId) {
          const dialogBox = document.getElementById("dialogBox");
          dialogBox.classList.remove("hidden");

          const sectionsContainer =
            document.getElementById("sectionsContainer");
          sectionsContainer.innerHTML = ""; // Clear previous content

          let techniciansList = [];
          let sectionsData = [];
          let sectionTechnicianMapping = [];

          // Fetch existing technicians and sections from the server
          async function fetchTechniciansAndSections() {
            try {
              const response = await fetch("/getSectionTechnician"); // Replace with your actual API endpoint
              const data = await response.json();

              techniciansList = data.technicians || [];
              sectionsData = data.sections.map((section) => ({
                sectionName: section.sectionName,
                technicians: [],
              }));

              console.log(sectionsData);
              console.log("Fetched data:", data);
            } catch (error) {
              console.error("Error fetching data:", error);
            }
          }

          // Save a new section to the server
          async function saveSection(section) {
            console.log("Request Body Section:", section);
            try {
              const response = await fetch("/addSection", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(section),
              });

              if (!response.ok) {
                throw new Error("Failed to save section.");
              }
              const data = await response.json();
              console.log("Saved Section:", data.section);
              return data.section;
            } catch (error) {
              console.error(error);
              alert("Error saving section.");
              return null;
            }
          }
          function renderSection(section) {
            const sectionDiv = document.createElement("div");
            sectionDiv.classList.add("section");
            console.log(section + "+" + section.sectionName); // Updated to section.sectionName

            const sectionHeader = document.createElement("h4");
            sectionHeader.textContent = section.sectionName; // Accessing sectionName instead of name

            const subsectionsContainer = document.createElement("div");
            subsectionsContainer.classList.add("subsections-container");

            // Add technician dropdown
            addTechnicianDropdown(subsectionsContainer, section.sectionName);

            const addTechnicianBtn = document.createElement("button");
            addTechnicianBtn.textContent = "Add Technician";
            addTechnicianBtn.classList.add("add-technician-btn");
            addTechnicianBtn.onclick = () =>
              addTechnicianDropdown(subsectionsContainer, section.sectionName);

            const removeSectionBtn = document.createElement("button");
            removeSectionBtn.textContent = "Remove Section";
            removeSectionBtn.classList.add("remove-section-btn");
            removeSectionBtn.onclick = () => sectionDiv.remove();

            sectionDiv.appendChild(sectionHeader);
            sectionDiv.appendChild(subsectionsContainer);
            sectionDiv.appendChild(addTechnicianBtn);
            sectionDiv.appendChild(removeSectionBtn);

            sectionsContainer.appendChild(sectionDiv);
          }
          // Add a dropdown for technician selection
          function addTechnicianDropdown(container, sectionName) {
            const subsectionDiv = document.createElement("div");
            subsectionDiv.classList.add("subsection");

            const select = document.createElement("select");
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Choose Technician";
            defaultOption.disabled = true;
            defaultOption.selected = true;

            select.appendChild(defaultOption);

            techniciansList.forEach((technician) => {
              const option = document.createElement("option");
              option.value = technician.name;
              option.textContent = technician.name;
              select.appendChild(option);
            });

            const removeSubsectionBtn = document.createElement("button");
            removeSubsectionBtn.textContent = "Remove";
            removeSubsectionBtn.classList.add("remove-subsection-btn");
            removeSubsectionBtn.onclick = () => subsectionDiv.remove();

            subsectionDiv.appendChild(select);
            subsectionDiv.appendChild(removeSubsectionBtn);
            container.appendChild(subsectionDiv);
          }

          // Initialize dialog with fetched data
          await fetchTechniciansAndSections();

          // Render sections without technicians
          sectionsData.forEach((section) => renderSection(section));

          // Add new section handler
          document.getElementById("addSectionBtn").onclick = async () => {
            const sectionName = prompt("Enter Section Name:");
            if (!sectionName) {
              alert("Section name is required.");
              return;
            }

            const existingSection = sectionsData.find(
              (sec) => sec.sectionName === sectionName
            );
            if (existingSection) {
              alert("This section already exists.");
              return;
            }

            const newSection = await saveSection({ name: sectionName });
            // const newSectionName=sectionName;
            if (newSection) {
              sectionsData.push(newSection);
              //await fetchTechniciansAndSections();
              console.log(sectionsData.name);
              console.log("New Section " + newSection.name);
              //console.log(newSectionName);
              renderSection(newSection.name);
              // Render sections without technicians
              //sectionsData.forEach((section) => renderSection(section));
            }
          };
          document.getElementById("saveBtn").onclick = async () => {
            sectionTechnicianMapping = Array.from(
              sectionsContainer.getElementsByClassName("section")
            ).map((section) => {
              const sectionName = section.querySelector("h4").textContent;
              const technicians = Array.from(
                section.getElementsByClassName("subsection")
              ).map((subsection) => subsection.querySelector("select").value);

              return { sectionName, technicians: technicians.filter(Boolean) }; // Filter out empty selections
            });

            console.log(
              "Mapping for booking:",
              bookingId,
              userId,
              sectionTechnicianMapping
            );

            try {
              const response = await fetch("/saveSectionTechnicianMapping", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  bookingId,
                  userId,
                  mapping: sectionTechnicianMapping,
                }),
              });

              if (!response.ok) {
                throw new Error("Failed to save mapping.");
              }

              const data = await response.json();
              console.log("Saved Mapping:", data);
              approveBooking(bookingId);

              alert("Mapping saved successfully.");
              dialogBox.classList.add("hidden");
            } catch (error) {
              console.error("Error saving mapping:", error);
              alert("Error saving mapping.");
            }
          };

          document.getElementById("cancelBtn").onclick = () => {
            dialogBox.classList.add("hidden");
          };
        }
        // Updated `approveBooking` Function
        function approveBooking(bookingId) {
          fetch("https://auditorium-booking-i34f.onrender.com/admin/approve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              bookingId: bookingId,
            }),
          })
            .then((response) => {
              if (response.ok) {
                console.log("Booking approved successfully");
                showMessage("Booking approved successfully", "success");
                return fetchBookings().then(displayBookings);
              } else {
                console.error("Failed to approve booking");
                showMessage("Failed to approve booking", "error");
              }
            })
            .catch((error) => {
              console.error("Error approving booking:", error);
              showMessage("Error approving booking", "error");
            });
        }

        function cancelBooking(bookingId, reasonToSend) {
          fetch("https://auditorium-booking-i34f.onrender.com/admin/cancel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              bookingId: bookingId,
              reason: reasonToSend,
            }), // Pass reason as well
          })
            .then((response) => response.json())
            .then((response) => {
              console.log(response);
              if (response.success) {
                console.log("Booking canceled successfully");
                showMessage("Booking canceled successfully", "success");
              } else {
                console.error("Failed to cancel booking");
                showMessage("Failed to cancel booking", "error");
              }
              return fetchBookings().then(displayBookings);
            })
            .catch((error) => {
              console.error("Error canceling booking:", error);
              showMessage("Error canceling booking", "error");
            });
        }

        // Attach event listeners to buttons after the bookings are displayed
        function attachEventListeners() {
          
          // Function to create and download CSV
          function downloadCSV(data, filename) {
            const csvRows = [];
            // Headers
            const headers = Object.keys(data[0]);
            csvRows.push(headers.join(","));

            // Data rows
            for (const row of data) {
              const values = headers.map((header) => row[header]);
              csvRows.push(values.join(","));
            }

            const csvString = csvRows.join("\n");
            const blob = new Blob([csvString], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
          }

          function showModal(title, columns, data) {
            const modal = document.getElementById("modal");
            const modalTitle = document.getElementById("modal-title");
            const modalTable = document.getElementById("modal-table");

            // Set modal title
            modalTitle.textContent = title;

            // Clear existing table content
            modalTable.innerHTML = "";

            // Create table headers
            const headerRow = document.createElement("tr");
            columns.forEach((col) => {
              const th = document.createElement("th");
              th.textContent = col;
              headerRow.appendChild(th);
            });
            modalTable.appendChild(headerRow);

            // Create table rows for data
            data.forEach((item) => {
              const row = document.createElement("tr");
              columns.forEach((col) => {
                const td = document.createElement("td");
                td.textContent = item[col.toLowerCase()];
                row.appendChild(td);
              });
              modalTable.appendChild(row);
            });

            // Display the modal
            modal.style.display = "block";
          }

          // Close modal when the "x" button is clicked
          document.querySelector(".close").onclick = function () {
            document.getElementById("modal").style.display = "none";
          };

          // Close modal if the user clicks outside the modal content
          window.onclick = function (event) {
            const modal = document.getElementById("modal");
            if (event.target == modal) {
              modal.style.display = "none";
            }
          };

          // Show User Data
          document.getElementById("show-user").onclick = async () => {
            try {
              const response = await fetch("/getUsers");
              const data = await response.json();
              console.log(data.users);
              if (data.success) {
                showModal(
                  "User Data",
                  ["Name", "Email", "Dept", "Phone"],
                  data.users
                );
              } else {
                alert("Failed to fetch user details.");
              }
            } catch (error) {
              console.error("Error fetching users:", error);
            }
          };

          // Show Admin Data
          document.getElementById("show-admin").onclick = async () => {
            try {
              const response = await fetch("/getAdmins");
              const data = await response.json();
              console.log(data);
              if (data.success) {
                showModal(
                  "Admin Data",
                  ["Name", "Email", "Department"],
                  data.admins
                );
              } else {
                alert("Failed to fetch admin details.");
              }
            } catch (error) {
              console.error("Error fetching admins:", error);
            }
          };

          document.getElementById("show-technician").onclick = async () => {
            // Show the dialog box
            const dialogBox = document.getElementById("dialogBox");
            dialogBox.classList.remove("hidden");

            // Fetch technician names from the server
            try {
              const response = await fetch("/getTechnicianNames");
              const data = await response.json();
              if (data.success) {
                const technicianDropdown =
                  document.getElementById("technicianDropdown");
                technicianDropdown.innerHTML = ""; // Clear existing options

                data.technicianNames.forEach((technician) => {
                  const option = document.createElement("option");
                  option.value = technician;
                  option.textContent = technician;
                  technicianDropdown.appendChild(option);
                });
              } else {
                alert("Failed to fetch technician names");
              }
            } catch (error) {
              console.error("Error fetching technician names:", error);
              alert("Error fetching technician names");
            }
          };

          // Handle the "OK" button click to send technician name to server
          document.getElementById("okBtn").onclick = async () => {
            const technicianName =
              document.getElementById("technicianDropdown").value;
            if (!technicianName) {
              alert("Please select a technician");
              return;
            }

            try {
              const response = await fetch(
                `/getTechnicianDetails?technicianName=${technicianName}`
              );
              const data = await response.json();

              if (data.success) {
                console.log("Technician Work Details:", data.data);
                // You can further process or display the technician details here
              } else {
                alert("Failed to fetch technician work details");
              }
            } catch (error) {
              console.error("Error fetching technician details:", error);
              alert("Error fetching technician details");
            }

            // Hide the dialog box after the action
            document.getElementById("dialogBox").classList.add("hidden");
          };

          // Handle the "Cancel" button click to close the dialog
          document.getElementById("cancelBtn").onclick = () => {
            document.getElementById("dialogBox").classList.add("hidden");
          };

          // document.getElementById("show-technician").onclick = async () => {
          //   try {
          //     const response = await fetch("/getTechnicianWorkDetails");
          //     const data = await response.json();
          //     console.log(data);
          //     console.log(data.data);

          //     if (data.success) {
          //       // Map the data with added checks for technicianNames
          //       const technicianData = data.data.map((item) => ({
          //         sectionname: item.SectionName,
          //         techniciannames: Array.isArray(item.TechnicianNames)
          //           ? item.TechnicianNames.join(", ")
          //           : item.TechnicianNames || "N/A", // If it's not an array, show "N/A"
          //         bookingdate: new Date(item.BookingDate).toLocaleDateString(), // Format the date
          //         starttime: item.StartTime,
          //         endtime: item.EndTime,
          //       }));
          //       console.log(technicianData);

          //       // Show modal with the correct data
          //       showModal(
          //         "Technician Data",
          //         [
          //           "SectionName",
          //           "TechnicianNames",
          //           "BookingDate",
          //           "StartTime",
          //           "EndTime",
          //         ],
          //         technicianData
          //       );
          //     } else {
          //       alert("Failed to fetch technician details.");
          //     }
          //   } catch (error) {
          //     console.error("Error fetching technicians:", error);
          //   }
          // };

          // Print User CSV
          document.getElementById("print-user").onclick = async () => {
            try {
              const response = await fetch("/getUsers");
              const data = await response.json();

              if (data.success) {
                downloadCSV(data.users, "users.csv");
              } else {
                alert("Failed to fetch user details.");
              }
            } catch (error) {
              console.error("Error fetching users:", error);
            }
          };

          // Print Admin CSV
          document.getElementById("print-admin").onclick = async () => {
            try {
              const response = await fetch("/getAdmins");
              const data = await response.json();

              if (data.success) {
                downloadCSV(data.admins, "admins.csv");
              } else {
                alert("Failed to fetch admin details.");
              }
            } catch (error) {
              console.error("Error fetching admins:", error);
            }
          };

          //// Click handler for printing technician data
          document.getElementById("print-technician").onclick = async () => {
            try {
              const response = await fetch("/getTechnicianWorkDetails");
              const data = await response.json();

              if (data.success) {
                // Map the data with added checks for technicianNames
                const technicianData = data.data.map((item) => ({
                  SectionName: item.SectionName,
                  TechnicianNames: Array.isArray(item.TechnicianNames)
                    ? item.TechnicianNames.join(", ") // Join technician names if array
                    : item.TechnicianNames || "N/A", // If it's not an array, show "N/A"
                  BookingDate: new Date(item.BookingDate).toLocaleDateString(), // Format the date
                  StartTime: item.StartTime,
                  EndTime: item.EndTime,
                }));
                console.log(technicianData);

                // Trigger the CSV download with the mapped data
                downloadCSV(technicianData, "technicians.csv");
              } else {
                alert("Failed to fetch technician details.");
              }
            } catch (error) {
              console.error("Error fetching technicians:", error);
            }
          };

          document.getElementById("print-csv").addEventListener("click", () => {
            fetchBookings().then((bookings) => {
              exportBookingsToCSV(bookings);
            });
          });
        }

        // Fetch and display bookings on page load
        fetchBookings()
          .then((bookings) => {
            displayBookings(bookings); // Display bookings in the table
            initializeCalendar(bookings); // Initialize calendar with bookings
          })
          .catch((error) => {
            console.error("Error fetching bookings:", error);
            showMessage("Error fetching bookings", "error");
          });
      });
    </script>
  </body>
</html>
